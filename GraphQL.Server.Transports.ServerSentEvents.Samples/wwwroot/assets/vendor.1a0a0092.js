const G="x-graphql-event-stream-token";function R(e){if(e=e,e!=="next"&&e!=="complete")throw new Error(`Invalid stream event "${e}"`);return e}function J(e,t){if(t)try{t=JSON.parse(t)}catch{throw new Error("Invalid stream data")}if(e==="next"&&!t)throw new Error('Stream data must be an object for "next" events');return t||null}function $(e){return typeof e=="object"&&e!==null}var N;(function(e){e[e.NewLine=10]="NewLine",e[e.CchunkiageReturn=13]="CchunkiageReturn",e[e.Space=32]="Space",e[e.Colon=58]="Colon"})(N||(N={}));function z(){let e,t,a,c=!1,w={event:"",data:""},l=[];const y=new TextDecoder;return function(g){if(e===void 0)e=g,t=0,a=-1;else{const o=new Uint8Array(e.length+g.length);o.set(e),o.set(g,e.length),e=o}const b=e.length;let u=0;for(;t<b;){c&&(e[t]===N.NewLine&&(u=++t),c=!1);let o=-1;for(;t<b&&o===-1;++t)switch(e[t]){case N.Colon:a===-1&&(a=t-u);break;case N.CchunkiageReturn:c=!0;case N.NewLine:o=t;break}if(o===-1)break;if(u===o){if(w.event||w.data){if(!w.event)throw new Error("Missing message event");const n=R(w.event),v=J(n,w.data);l.push({event:n,data:v}),w={event:"",data:""}}}else if(a>0){const n=e.subarray(u,o),v=y.decode(n.subarray(0,a)),f=a+(n[a+1]===N.Space?2:1),x=y.decode(n.subarray(f));switch(v){case"event":w.event=x;break;case"data":w.data=w.data?w.data+`
`+x:x;break}}u=t,a=-1}if(u===b){e=void 0;const o=[...l];return l=[],o}else u!==0&&(e=e.subarray(u),t-=u)}}var O=globalThis&&globalThis.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],a;return t?t.call(e):(e=typeof __values=="function"?__values(e):e[Symbol.iterator](),a={},c("next"),c("throw"),c("return"),a[Symbol.asyncIterator]=function(){return this},a);function c(l){a[l]=e[l]&&function(y){return new Promise(function(h,g){y=e[l](y),w(h,g,y.done,y.value)})}}function w(l,y,h,g){Promise.resolve(g).then(function(b){l({value:b,done:h})},y)}},D=globalThis&&globalThis.__await||function(e){return this instanceof D?(this.v=e,this):new D(e)},U=globalThis&&globalThis.__asyncGenerator||function(e,t,a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var c=a.apply(e,t||[]),w,l=[];return w={},y("next"),y("throw"),y("return"),w[Symbol.asyncIterator]=function(){return this},w;function y(n){c[n]&&(w[n]=function(v){return new Promise(function(f,x){l.push([n,v,f,x])>1||h(n,v)})})}function h(n,v){try{g(c[n](v))}catch(f){o(l[0][3],f)}}function g(n){n.value instanceof D?Promise.resolve(n.value.v).then(b,u):o(l[0][2],n)}function b(n){h("next",n)}function u(n){h("throw",n)}function o(n,v){n(v),l.shift(),l.length&&h(l[0][0],l[0][1])}};function B(e){const{singleConnection:t=!1,lazy:a=!0,onNonLazyError:c=console.error,generateID:w=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const d=Math.random()*16|0;return(s=="x"?d:d&3|8).toString(16)})},retryAttempts:l=5,retry:y=async function(s){let d=1e3;for(let m=0;m<s;m++)d*=2;await new Promise(m=>setTimeout(m,d+Math.floor(Math.random()*(3e3-300)+300)))}}=e,h=e.fetchFn||fetch,g=e.abortControllerImpl||AbortController,b=(()=>{let r=!1;const s=[];return{get disposed(){return r},onDispose(d){return r?(setTimeout(()=>d(),0),()=>{}):(s.push(d),()=>{s.splice(s.indexOf(d),1)})},dispose(){if(!r){r=!0;for(const d of[...s])d()}}}})();let u,o,n=0,v=null,f=0;async function x(){try{if(b.disposed)throw new Error("Client has been disposed");return await(o!=null?o:o=(async()=>{var r;if(v){if(await y(f),u.signal.aborted)throw new Error("Connection aborted by the client");f++}u=new g;const s=b.onDispose(()=>u.abort());u.signal.addEventListener("abort",()=>{s(),o=void 0});const d=typeof e.url=="function"?await e.url():e.url;if(u.signal.aborted)throw new Error("Connection aborted by the client");const m=typeof e.headers=="function"?await e.headers():(r=e.headers)!==null&&r!==void 0?r:{};if(u.signal.aborted)throw new Error("Connection aborted by the client");let i;try{i=await h(d,{signal:u.signal,method:"PUT",headers:m})}catch(S){throw new I(S)}if(i.status!==201)throw new I(i);const P=await i.text();m[G]=P;const p=await M({signal:u.signal,headers:m,url:d,fetchFn:h});return v=null,f=0,p.waitForThrow().catch(()=>o=void 0),p})())}catch(r){throw o=void 0,r}}return t&&!a&&(async()=>{for(n++;;)try{const{waitForThrow:r}=await x();await r()}catch(r){if(b.disposed)return;if(!(r instanceof I)||!l||f>=l)return c==null?void 0:c(r);v=r}})(),{subscribe(r,s){if(!t){const i=new g,P=b.onDispose(()=>{P(),i.abort()});return(async()=>{var p,S,L;let k=null,E=0;for(;;)try{if(k){if(await y(E),i.signal.aborted)throw new Error("Connection aborted by the client");E++}const _=typeof e.url=="function"?await e.url():e.url;if(i.signal.aborted)throw new Error("Connection aborted by the client");const T=typeof e.headers=="function"?await e.headers():(L=e.headers)!==null&&L!==void 0?L:{};if(i.signal.aborted)throw new Error("Connection aborted by the client");const{getResults:F}=await M({signal:i.signal,headers:T,url:_,body:JSON.stringify(r),fetchFn:h});k=null,E=0;try{for(var C=(p=void 0,O(F())),j;j=await C.next(),!j.done;){const A=j.value;s.next(A)}}catch(A){p={error:A}}finally{try{j&&!j.done&&(S=C.return)&&await S.call(C)}finally{if(p)throw p.error}}return i.abort()}catch(_){if(i.signal.aborted)return;if(!(_ instanceof I)||!l||E>=l)throw _;k=_}})().then(()=>s.complete()).catch(p=>s.error(p)),()=>i.abort()}n++;const d=new g,m=b.onDispose(()=>{m(),d.abort()});return(async()=>{var i,P;const p=w();r=Object.assign(Object.assign({},r),{extensions:Object.assign(Object.assign({},r.extensions),{operationId:p})});let S=null;for(;;){S=null;try{const{url:E,headers:C,getResults:j}=await x();let _;try{_=await h(E,{signal:d.signal,method:"POST",headers:C,body:JSON.stringify(r)})}catch(T){throw new I(T)}if(_.status!==202)throw new I(_);S=async()=>{let T;try{const F=new g,A=b.onDispose(()=>{A(),F.abort()});T=await h(E+"?operationId="+p,{signal:F.signal,method:"DELETE",headers:C})}catch(F){throw new I(F)}if(T.status!==200)throw new I(T)};try{for(var L=(i=void 0,O(j({signal:d.signal,operationId:p}))),k;k=await L.next(),!k.done;){const T=k.value;s.next(T)}}catch(T){i={error:T}}finally{try{k&&!k.done&&(P=L.return)&&await P.call(L)}finally{if(i)throw i.error}}return S=null,d.abort()}catch(E){if(d.signal.aborted)return await(S==null?void 0:S());if(!(E instanceof I)||!l||f>=l)throw E;v=E}finally{d.signal.aborted&&--n==0&&u.abort()}}})().then(()=>s.complete()).catch(i=>s.error(i)),()=>d.abort()},dispose(){b.dispose()}}}class I extends Error{constructor(t){let a,c;K(t)?(c=t,a="Server responded with "+t.status+": "+t.statusText):t instanceof Error?a=t.message:a=String(t);super(a);this.name=this.constructor.name,this.response=c}}function K(e){return $(e)&&typeof e.ok=="boolean"&&typeof e.status=="number"&&typeof e.statusText=="string"}async function M(e){const{signal:t,url:a,headers:c,body:w,fetchFn:l}=e,y={},h={};let g;try{g=await l(a,{signal:t,method:w?"POST":"GET",headers:Object.assign(Object.assign({},c),{accept:"text/event-stream"}),body:w})}catch(o){throw new I(o)}if(!g.ok)throw new I(g);if(!g.body)throw new Error("Missing response body");let b=null,u=null;return(async()=>{var o,n,v;try{const r=z();try{for(var f=O(V(g.body)),x;x=await f.next(),!x.done;){const s=x.value;if(typeof s=="string")throw new Error(`Unexpected string chunk "${s}"`);const d=r(s);if(!!d)for(const m of d){const i=m.data&&"id"in m.data?m.data.id:"";switch(i in h||(h[i]=[]),m.event){case"next":i?h[i].push(m.data.payload):h[i].push(m.data);break;case"complete":h[i].push("complete");break;default:throw new Error(`Unexpected message event "${m.event}"`)}(v=y[i])===null||v===void 0||v.proceed()}}}catch(s){o={error:s}}finally{try{x&&!x.done&&(n=f.return)&&await n.call(f)}finally{if(o)throw o.error}}}catch(r){b=r,u&&u(r)}finally{Object.values(y).forEach(({proceed:r})=>r())}})(),{url:a,headers:c,waitForThrow:()=>new Promise((o,n)=>{if(b)return n(b);u=n}),getResults(o){var n;return U(this,arguments,function*(){const{signal:f,operationId:x=""}=o!=null?o:{};try{for(;;){for(;(n=h[x])===null||n===void 0?void 0:n.length;){const r=h[x].shift();if(r==="complete")return yield D(void 0);yield yield D(r)}if(b)throw b;if(f==null?void 0:f.aborted)throw new Error("Getting results aborted by the client");yield D(new Promise(r=>{const s=()=>{f==null||f.removeEventListener("abort",s),delete y[x],r()};f==null||f.addEventListener("abort",s),y[x]={proceed:s}}))}}finally{delete h[x]}})}}}function V(e){return typeof Object(e)[Symbol.asyncIterator]=="function"?(e=e,e[Symbol.asyncIterator]()):function(){return U(this,arguments,function*(){e=e;const t=e.getReader();for(;;){const{value:a,done:c}=yield D(t.read());if(c)return yield D(a);yield yield D(a)}})}()}export{B as c};
